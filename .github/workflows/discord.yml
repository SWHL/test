name: discord message
on:
  release:
    types: [published]  # åªåœ¨æ­£å¼å‘å¸ƒ release æ—¶è§¦å‘ï¼ˆä¸åŒ…æ‹¬è‰ç¨¿ï¼‰
  push:
    branches:
    - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release info
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY=$(gh api graphql -f query='
            query($owner:String!, $repo:String!, $tag:String!) {
              repository(owner:$owner, name:$repo) {
                release(tagName:$tag) {
                  description
                }
              }
            }' \
            -f owner='${{ github.repository_owner }}' \
            -f repo='${{ github.event.repository.name }}' \
            -f tag='${{ github.event.release.tag_name }}' \
            --jq '.data.repository.release.description')

          ESCAPED_BODY=$(echo "$BODY" | jq -Rs .)
          echo "release_body=$ESCAPED_BODY" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_USERNAME: Github Actions
          DISCORD_AVATAR: https://cdn.discordapp.com/avatars/1460099944252702846/e57fd67dc7ca0cc840a0e87a82281bc5.webp?size=80
        uses: Ilshidur/action-discord@0.4.0
        with:
          args: |
            ðŸš€ **New Release Published!**

            **Repository:** ${{ github.repository }}
            **Tag:** ${{ github.event.release.tag_name }}
            **Author:** ${{ github.event.release.author.login }}

            **Release Notes:**
            ${{ fromJSON(steps.get_release.outputs.release_body) }}